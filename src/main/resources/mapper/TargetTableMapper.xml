<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kt.yaap.mig_batch.mapper.TargetTableMapper">

    <!-- INFORMATION_SCHEMA에서 Primary Key 컬럼명 조회 (PostgreSQL) - 단일키용 -->
    <select id="selectPrimaryKeyColumn" resultType="string">
        SELECT kcu.column_name
        FROM information_schema.table_constraints tc
        JOIN information_schema.key_column_usage kcu 
            ON tc.constraint_name = kcu.constraint_name
            AND tc.table_schema = kcu.table_schema
        WHERE tc.table_schema = COALESCE(#{params.schemaName}, 'public')
          AND tc.table_name = #{params.tableName}
          AND tc.constraint_type = 'PRIMARY KEY'
        ORDER BY kcu.ordinal_position
        LIMIT 1
    </select>

    <!-- INFORMATION_SCHEMA에서 모든 Primary Key 컬럼명 조회 (복합키 지원) -->
    <select id="selectPrimaryKeyColumns" resultType="string">
        SELECT kcu.column_name
        FROM information_schema.table_constraints tc
        JOIN information_schema.key_column_usage kcu 
            ON tc.constraint_name = kcu.constraint_name
            AND tc.table_schema = kcu.table_schema
        WHERE tc.table_schema = COALESCE(#{params.schemaName}, 'public')
          AND tc.table_name = #{params.tableName}
          AND tc.constraint_type = 'PRIMARY KEY'
        ORDER BY kcu.ordinal_position
    </select>

    <!-- 대상 테이블에서 PK와 컬럼 값 조회 (단일키/복합키 통일 처리) -->
    <select id="selectTargetRecords" resultType="java.util.HashMap">
        SELECT 
            <foreach collection="params.pkColumnNames" item="pkCol" separator=",">
                ${pkCol} AS "pk_${pkCol}"
            </foreach>,
            ${params.columnName} AS original_value,
            #{params.tableName} AS target_table_name,
            #{params.columnName} AS target_column_name
        FROM ${params.tableName}
        <if test="params.whereCondition != null and params.whereCondition != ''">
            WHERE ${params.whereCondition}
        </if>
        ORDER BY 
            <foreach collection="params.pkColumnNames" item="pkCol" separator=",">
                ${pkCol}
            </foreach>
    </select>

    <!-- 대상 테이블 업데이트 (여러 컬럼을 한 번에 처리, 단일키/복합키 통일 처리) -->
    <update id="updateTargetRecordWithMultipleColumns">
        UPDATE ${params.tableName}
        SET
        <foreach collection="params.columnUpdates" item="column" separator=",">
            ${column.backupColumnName} = #{column.originalValue},
            ${column.columnName} = #{column.encryptedValue}
        </foreach>
        WHERE 
            <foreach collection="params.pkColumnNames" item="pkCol" separator=" AND ">
                ${pkCol} = #{params.pkValues[${pkCol}]}
            </foreach>
    </update>


</mapper>

