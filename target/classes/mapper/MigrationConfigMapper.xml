<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kt.yaap.mig_batch.mapper.MigrationConfigMapper">

    <!-- ResultMap -->
    <resultMap id="MigrationConfigResultMap" type="com.kt.yaap.mig_batch.model.MigrationConfigEntity">
        <result property="targetTableName" column="target_table_name"/>
        <result property="targetColumnName" column="target_column_name"/>
    </resultMap>

    <!-- 마이그레이션 설정 목록 조회 (COMPLETE 상태 제외) -->
    <select id="selectActiveConfigs" resultMap="MigrationConfigResultMap">
        SELECT 
            target_table_name,
            target_column_name
        FROM migration_config
        WHERE status IS NULL OR status = 'ACTIVE'
        ORDER BY priority, target_table_name
    </select>

    <!-- 마이그레이션 설정 상태 업데이트 -->
    <update id="updateStatus">
        UPDATE migration_config
        SET status = #{status}
        WHERE target_table_name = #{targetTableName}
    </update>

    <!-- 특정 테이블의 마이그레이션 설정 조회 -->
    <select id="selectByTableName" resultMap="MigrationConfigResultMap">
        SELECT 
            target_table_name,
            target_column_name
        FROM migration_config
        WHERE target_table_name = #{targetTableName}
          AND (status IS NULL OR status = 'ACTIVE')
        LIMIT 1
    </select>

</mapper>

